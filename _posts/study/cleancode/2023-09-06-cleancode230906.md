---
layout: post
title: " 동시성(3) "
subtitle: " 스레드 코드 테스트하기 "
catalog: true
category: study
subcategory: cleancode
tags:
  - study
  - cleancode
  - 책너두
  - 동시성
  - 스레드
  - 다중 스레드
---

# 책너두 5기 27일차

로버트 C. 마틴의 **클린코드** p. 237~ p.244

# 내용정리

## 13.동시성

### 스레드 코드 테스트하기

지금까지 공부한 것은 스레드가 하나인 프로그램은 지금까지 한 말이 모두 옳다. 하지만 같은 코드와 같은 자원을 사용하는 스레드가 둘 이상으로 늘어나면 다르다.

**권장사항**: 문제를 노출하는 테스트 케이스를 작성하라. 프로그램 설정과 시스템 설정과 부하를 바꿔가며 자주 돌려라. 실패하면 원인을 추적하라.

스레드가 둘 이상일 때 지침은 다음과 같다.

- 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라.
- 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자.
- 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있도록 스레드 코드를 구현하라.
- 다중 스레드를 쓰는 코드 부분을 상황에 맞춰 조정할 수 있게 작성하라.
- 프로세서 수보다 많은 스레드를 돌려보라.
- 다른 플랫폼에서 돌려보라.
- 코드에 보조 코드(instrument)를 넣어 돌려라. 강제로 실패를 일으키게 해보라.

#### 말이 안되는 실패는 잠정적인 스레드 문제로 취급하라

다중 스레드 코드는 아주 드물게 한번씩 나타나서 실패를 재현하기 아주 어렵고 그로 인해 일회성 문제로 치부한다. 그렇게 되면 잘못된 코드위에 코드가 계속 쌓인다.

**권장사항**: 시스템 실패를 '일회성'이라 치부하지 마라.

#### 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자

스레드 환경 밖에서 코드가 제대로 도는지 반드시 확인한다. 일반적인 방법으로, 스레드가 호출하는 POJO(Plain Old Java Object, 평범한 자바 객체)를 만든다.

**권장사항**: 먼저 스레드 환경 밖에서 코드를 올바로 돌린 후 버그를 디버깅해라.

#### 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있게 스레드 코드를 구현하라

- 한 스레드로 실행하거나, 여러 스레드로 실행하거나, 실행 중 스레드 수를 바꿔본다.
- 스레드 코드를 실제 환경이나 테스트 환경에서 돌려본다.
- 테스트 코드를 빨리, 천천히, 다양한 속도로 돌려본다.
- 반복 테스트가 가능하도록 테스트 케이스를 작성한다.

**권장사항**: 다양한 설정에서 실행할 목적으로 다른 환경에 쉽게 끼워 넣을 수 있게 코드를 구현하라.

#### 다중 스레드를 쓰는 코드 부분을 상황에 맞게 조율할 수 있게 작성하라

스레드 개수를 조율하기 쉽게 코드를 구현한다. 프로그램 처리율과 효율에 따라 스스로 스레드 개수를 조율하는 코드도 고민한다.

#### 프로세서 수보다 많은 스레드를 돌려보라

시스템이 스레드를 스와핑(swapping)할 때도 문제가 발생한다. 스와핑이 잦을수록 임계영역을 빼먹은 코드나 데드락을 일으키는 코드를 찾기 쉬워진다.

#### 다른 플랫폼에서 돌려보라

코드가 돌아갈 가능성이 있는 플랫폼 전부에서 테스트를 수행해야 마땅하다.

**권장사항**: 처음부터 그리고 자주 모든 목표 플랫폼에서 코드를 돌려라.

#### 코드에 보조 코드(instrument)를 넣어 돌려라. 강제로 실패를 일으키게 해보라

스레드 버그가 산발적이고 우발적이고 재현이 어려운 이유는 코드가 실행되는 수천 가지 경로 중에 아주 소수만 실패하기 때문이다. 이 오류를 좀 더 자주 일으킬 방법은 보조 코드를 추가해 코드가 실행되는 순서를 바꿔주는 것이다. 이러면 버그가 드러날 가능성도 높아진다. 코드에 보조 코드를 추가하는 바업ㅂ은 두 가지다.

- 직접 구현하기
- 자동화

##### 직접 구현하기

코드에다 직접 `wait()`, `sleep()`, `yield()`, `priority()` 함수를 추가한다. 다음을 고려해야 한다.

- 보조 코드를 삽입할 적정 위치를 직접 찾아야 한다.
- 어떤 함수를 어디서 호출해야 적당한지 어떻게 알까?
- 배포 환경에 보조 코드를 그대로 남겨두면 프로그램 성능이 떨어진다.
- 무작위적이다. 오류가 드러날지도 모르고 드러나지 않을지도 모른다. 사실상 드러나지 않을 확률이 더 높다.

##### 자동화

보조 코드를 자동으로 추가하려면 AOF(Aspect-Oriendted Framework), GGLIB, ASM 등과 같은 도구를 사용한다.

코드를 흔드는(jiggle) 이유는 스레드를 매번 다른 순서로 실행하기 위해서다. 좋은 테스트 케이스와 흔들기(jiggling) 기법은 오류가 드러날 확률을 크게 높여준다.

**권장사항**: 흔들기 기법을 사용해 오류를 찾아내라.

### 결론

다중 스레드 코드를 작성한다면 각별히 깨끗하게 코드를 짜야 한다. 먼저, SRP(Single Responsibility Principle)를 준수한다. 또한 동시성 오류를 일으키는 잠정적인 원인을 철저히 이해한다. 뿐만 아니라, 사용하는 라이브러리와 기본 알고리즘을 이해하고, 보호할 코드 영역을 찾아내는 방법과 특정 코드 영역을 잠그는 방법도 이해해야 한다. 그럼에도 문제는 계속 발생하므로 많은 플랫폼에서 많은 설정으로 반복해서 계속 테스트해야 한다.

# 읽고 나서

PintOS에서 배웠던 다중 스레드이다. 복잡하고 어려운 만큼 내가 이해하지 못하는, 혹은 발견조차 못하는 버그와 오류들이 많이 발생할 수 있다. 끊임없이 반복해서 다양하게 테스트해서 극복해야 한다.
