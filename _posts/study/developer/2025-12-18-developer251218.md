---
layout: post
title: "Redis Connection closed by server ì˜¤ë¥˜"
subtitle: "ì¢€ë¹„ ì»¤ë„¥ì…˜ê³¼ retry"
catalog: true
category: study
subcategory: developer
tags:
  - developer
  - study
  - redis
  - connection

---

# Redis ì—°ê²°ì˜¤ë¥˜ í•´ê²°ê¸°

# ì‚¬ê±´ ë°°ê²½

ì‹¬ê¸°ê°€ ë¶ˆí¸í•œ ì¼ìš”ì¼ ì˜¤í›„ ì„œë²„ëŠ” ìš¸ê¸° ì‹œì‘í–ˆë‹¤.

![1](https://cdn.jsdelivr.net/gh/importunate-dev/importunate-dev.github.io/img/developer/251218/251218-1.webp)

â€œì‘ì• ! ì‘ì• ! Connection closed by server! ì‘ì• !â€

ì„œë²„ì˜ ì›¹í›… ê´€ë ¨ ìºì‹œì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡Œë‹¤ëŠ” ì˜¤ë¥˜ë“¤ì´ì—ˆë‹¤.

ì›¹í›…ì„ ìˆ˜ì‹ í•˜ë©´ ì›¹í›… ìºì‹œì„œë²„ì— íšŸìˆ˜ë¥¼ ê¸°ë¡í•˜ê¸° ìœ„í•œ ì‘ì—…ì´ ì´ë¤„ì§€ëŠ”ë° ì´ë–„ ì„œë²„ë¡œë¶€í„° ì—°ê²°ì´ ëŠê²¼ë‹¤ëŠ” ì—ëŸ¬ì˜€ë‹¤.

- Traceback
    
    ```
    Traceback (most recent call last):
      File "/code/core/webhook/utils/webhook.py", line 156, in record_webhook_event
        redis_client.zadd(key, {member: score})
      File "/usr/local/lib/python3.11/site-packages/redis/commands/core.py", line 4187, in zadd
        return self.execute_command("ZADD", name, *pieces, **options)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/ddtrace/contrib/redis/patch.py", line 148, in _traced_execute_command
        return _run_redis_command(span=span, func=func, args=args, kwargs=kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/ddtrace/contrib/redis/patch.py", line 128, in _run_redis_command
        result = func(*args, **kwargs)
                 ^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/client.py", line 559, in execute_command
        return self._execute_command(*args, **options)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/client.py", line 567, in _execute_command
        return conn.retry.call_with_retry(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/retry.py", line 65, in call_with_retry
        fail(error)
      File "/usr/local/lib/python3.11/site-packages/redis/client.py", line 571, in <lambda>
        lambda error: self._disconnect_raise(conn, error),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/client.py", line 555, in _disconnect_raise
        raise error
      File "/usr/local/lib/python3.11/site-packages/redis/retry.py", line 62, in call_with_retry
        return do()
               ^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/client.py", line 568, in <lambda>
        lambda: self._send_command_parse_response(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/client.py", line 542, in _send_command_parse_response
        return self.parse_response(conn, command_name, **options)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/client.py", line 584, in parse_response
        response = connection.read_response()
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/connection.py", line 592, in read_response
        response = self._parser.read_response(disable_decoding=disable_decoding)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/_parsers/resp2.py", line 15, in read_response
        result = self._read_response(disable_decoding=disable_decoding)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/_parsers/resp2.py", line 25, in _read_response
        raw = self._buffer.readline()
              ^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/local/lib/python3.11/site-packages/redis/_parsers/socket.py", line 115, in readline
        self._read_from_socket()
      File "/usr/local/lib/python3.11/site-packages/redis/_parsers/socket.py", line 68, in _read_from_socket
        raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
    redis.exceptions.ConnectionError: Connection closed by server.
    
    ```
    

ì›¹í›… ì˜¤ë¥˜ì— ë°œì‘ë²„íŠ¼ì´ ë‹¬ë ¤ìˆëŠ” ë‚˜ëŠ” í™©ê¸‰íˆ ì›¹í›… ìºì‹œ ì§€í‘œë¥¼ í™•ì¸í–ˆë‹¤.

![2](https://cdn.jsdelivr.net/gh/importunate-dev/importunate-dev.github.io/img/developer/251218/251218-2.webp)

ì½ê¸° ìš”ì²­ ì§€ì—°ì‹œê°„ì´ ì ê¹ ê°ì†Œí•œ ê²ƒ ì™¸ì—ëŠ” ë³„ ì´ìŠˆê°€ ì—†ì—ˆë‹¤. ë¶„ëª… ê·¸ ì‹œê°„ì—ë„ ì˜ ì²˜ë¦¬ë˜ëŠ” ì›¹í›…ë“¤ì€ ì¡´ì¬í–ˆë‹¤. ì•„ì˜ˆ ì£½ì€ ê±´ ì•„ë‹ˆë¼ ìš°ì„ ì€ ëƒ…ë‘ê³  ë‚´ì¼ í•´ê°€ ë°ìœ¼ë©´ ë‹¤ì‹œëŠ” ìš¸ì§€ ëª»í•˜ê²Œ í•´ë²„ë¦¬ê² ë‹¤ê³  ë‹¤ì§í–ˆë‹¤.

## ì›ì¸

ì˜¤ë¥˜ê°€ ë‚œ í•¨ìˆ˜

```python
redis_pool_for_webhook = ConnectionPool(
    connection_class=SSLConnection,  # SSL ì—°ê²° í´ë˜ìŠ¤
    host=AWS_ELASTICACHE_WEBHOOK_REDIS_HOST,
    port=AWS_ELASTICACHE_WEBHOOK_REDIS_PORT,
    decode_responses=True,  # ë¬¸ìì—´ë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜
    ssl_cert_reqs=None,  # ì¸ì¦ì„œ ê²€ì¦ ë¹„í™œì„±í™” (í•„ìš” ì‹œ ë³€ê²½)
    max_connections=10,  # ìµœëŒ€ ì—°ê²° ìˆ˜
)

def record_webhook_event(
        mall_id: str, shop_no: int, event_type: str, num: int = 1
    ) -> None:
        """
        shopì— í•´ë‹¹í•˜ëŠ” Redis sorted setì— í˜„ì¬ ì‹œê°ì„ ê¸°ë¡í•©ë‹ˆë‹¤.

        - key: 'webhook_frequency_{mall_id}_{shop_no}'
        - score: í˜„ì¬ ì‹œê°„ì˜ Unix timestamp (ì´ˆ ë‹¨ìœ„)
        - member: ê³ ìœ  UUID (ì¤‘ë³µ ë°©ì§€)

        ë™ì (scoreê°€ ê°™ì€ ê°’)ìœ¼ë¡œ ë“¤ì–´ì™€ë„, ì„œë¡œ ë‹¤ë¥¸ memberì´ë©´ ëª¨ë‘ ì €ì¥ë©ë‹ˆë‹¤.
        """
        try:
            redis_client_for_webhook = Redis(connection_pool=redis_pool_for_webhook)

            with redis_client_for_webhook as redis_client:
                # Redis í‚¤ ìƒì„±
                key = f"webhook_frequency_{mall_id}_{shop_no}_{event_type}"

                for _ in range(num):
                    # í˜„ì¬ ì‹œê° (ì´ˆ ë‹¨ìœ„)
                    now_dt = datetime.now(tz=ZoneInfo("Asia/Seoul")).replace(
                        microsecond=0
                    )
                    score = int(now_dt.timestamp())

                    # memberëŠ” UUID
                    member = str(uuid.uuid4())

                    # sorted setì— ì¶”ê°€
                    redis_client.zadd(key, {member: score})
        except Exception as e:
            log_error(
                exception=e,
                context={
                    "mall_id": mall_id,
                    "shop_no": shop_no,
                },
                tags={"category": "webhook_blacklist"},
            )
```

## ê°œë…

ì›ì¸ì„ ì°¾ê¸° ìœ„í•´, ê°œë…ë¶€í„° ëª…í™•íˆ ì´í•´í•´ì•¼ í–ˆë‹¤.

```markdown
### ğŸ”Œ ì»¤ë„¥ì…˜ (Connection)

**ì»¤ë„¥ì…˜**ì€ í´ë¼ì´ì–¸íŠ¸(ìš°ë¦¬ ì„œë²„)ì™€ Redis ì„œë²„ ì‚¬ì´ì˜ "ì—°ê²° í†µë¡œ"ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ìš°ë¦¬ ì„œë²„   â”‚ â—€â”€â”€â”€â”€â”€ ì»¤ë„¥ì…˜ â”€â”€â”€â”€â”€â–¶ â”‚  Redis ì„œë²„  â”‚
â”‚  (Django)   â”‚      (ì—°ê²° í†µë¡œ)      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **ë¹„ìœ **: ì „í™” í†µí™”ë¥¼ ìƒê°í•´ë³´ì„¸ìš”. ì „í™”ë¥¼ ê±¸ë©´ "ì—°ê²°"ì´ ë˜ê³ , í†µí™”ê°€ ëë‚˜ë©´ "ì—°ê²° ì¢…ë£Œ"ê°€ ë©ë‹ˆë‹¤.
> ì»¤ë„¥ì…˜ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì„œë²„ì™€ Redis ì‚¬ì´ì— ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•œ ì—°ê²°ì…ë‹ˆë‹¤.

### ğŸŠ ì»¤ë„¥ì…˜ í’€ (Connection Pool)

**ì»¤ë„¥ì…˜ í’€**ì€ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘” ì»¤ë„¥ì…˜ë“¤ì˜ ëª¨ìŒì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ì»¤ë„¥ì…˜ í’€ (Pool)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ C1  â”‚ â”‚ C2  â”‚ â”‚ C3  â”‚ â”‚ ...â”‚   â”‚  (ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘” ì»¤ë„¥ì…˜ë“¤)
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **ë¹„ìœ **: ì½œì„¼í„°ë¥¼ ìƒê°í•´ë³´ì„¸ìš”. ì „í™”ê°€ ì˜¬ ë•Œë§ˆë‹¤ ìƒˆ ì „í™”ê¸°ë¥¼ ì‚¬ëŠ” ê²ƒë³´ë‹¤,
> ë¯¸ë¦¬ ì—¬ëŸ¬ ëŒ€ì˜ ì „í™”ê¸°ë¥¼ ì¤€ë¹„í•´ë‘ê³  í•„ìš”í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê²Œ íš¨ìœ¨ì ì´ì£ ?
> ì»¤ë„¥ì…˜ í’€ë„ ê°™ì€ ì›ë¦¬ì…ë‹ˆë‹¤.

**ì™œ ì‚¬ìš©í•˜ë‚˜ìš”?**
- ì»¤ë„¥ì…˜ì„ ë§¤ë²ˆ ìƒˆë¡œ ë§Œë“œëŠ” ê²ƒì€ ë¹„ìš©(ì‹œê°„)ì´ ë§ì´ ë“­ë‹ˆë‹¤
- ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘ë©´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ ë¹ ë¦…ë‹ˆë‹¤

### ğŸ§Ÿ ì¢€ë¹„ ì»¤ë„¥ì…˜ (Zombie Connection)

**ì¢€ë¹„ ì»¤ë„¥ì…˜**ì€ "ì£½ì—ˆì§€ë§Œ ì£½ì€ ì¤„ ëª¨ë¥´ëŠ”" ì»¤ë„¥ì…˜ì…ë‹ˆë‹¤.

```
[ì •ìƒ ìƒíƒœ]
ìš°ë¦¬ ì„œë²„ â—€â”€â”€â”€â”€ ğŸŸ¢ ì •ìƒ ì»¤ë„¥ì…˜ â”€â”€â”€â”€â–¶ Redis ì„œë²„
         (ì–‘ìª½ ëª¨ë‘ ì—°ê²° ìƒíƒœ ì¸ì‹)

[ì¢€ë¹„ ìƒíƒœ]
ìš°ë¦¬ ì„œë²„ â—€â”€â”€â”€â”€ ğŸ§Ÿ ì¢€ë¹„ ì»¤ë„¥ì…˜ â”€ âœ– â”€â–¶ Redis ì„œë²„
         (ì„œë²„ëŠ” ì—°ê²°ëœ ì¤„ ì•)    (RedisëŠ” ì´ë¯¸ ëŠìŒ)
```

> ğŸ’¡ **ë¹„ìœ **: ì „í™” í†µí™” ì¤‘ì— ìƒëŒ€ë°©ì´ ì¡°ìš©íˆ ëŠì—ˆëŠ”ë°, ë‚´ê°€ ê·¸ê±¸ ëª¨ë¥´ê³  ê³„ì† ë§í•˜ê³  ìˆëŠ” ìƒí™©ì…ë‹ˆë‹¤.
> ë‚˜ëŠ” ì—°ê²°ëœ ì¤„ ì•Œì§€ë§Œ, ì‹¤ì œë¡œëŠ” ëŠì–´ì§„ ìƒíƒœì£ .
```

ê°œë… ìì²´ëŠ” ì´í•´ê°€ ë˜ì—ˆìœ¼ë‚˜, ì½”ì–´ì—ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ë„ ì¢€ë¹„ ì»¤ë„¥ì…˜ ë•Œë¬¸ì¸ì§€ í™•ì‹ ì´ ì•ˆì„°ë‹¤. ì™œëƒí•˜ë©´

1. í•´ë‹¹ ì‹œê°„ëŒ€ëŠ” ì›¹í›…ì´ ê°€ì¥ ì ì€ ì‹œê°„ëŒ€
2. ê·¸ë ‡ë‹¤ê³  ì—°ê²°ì´ ì‰¬ëŠ” íƒ€ì´ë°ì€ ì—†ìœ¼ë©° ì´ˆë‹¹ ìˆ˜ ì‹­, ìˆ˜ ë°±ê°œëŠ” ì—¬ì „íˆ ë“¤ì–´ì˜´
3. ëª¨ë“  ìš”ì²­ì´ ì‹¤íŒ¨í•˜ëŠ” ê²ƒë„ ì•„ë‹˜

ë¼ì„œ.. ë„ëŒ€ì²´ ì™œ ì¢€ë¹„ ì»¤ë„¥ì…˜ì´ ê·¸ë•Œ ë°œìƒí•œ ê±´ì§€.. 

ì›ì¸ì€ ì°¾ì§€ ëª»í–ˆìœ¼ë‚˜ ì¦ìƒì€ ì•Œê³  ìˆê³  í•´ê²°í•´ì•¼í•œë‹¤.

## í•´ê²°ì±…

í•´ê²°ë°©ì‹ì€ ì‚¬ìš©í•˜ëŠ” Redis í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹œì ì— retry ì˜µì…˜ì„ ì¶”ê°€í•´ì£¼ëŠ” ê²ƒì´ì—ˆë‹¤. ì¢€ë¹„ ì»¤ë„¥ì…˜ì´ë“  ë­ë“  ì‹¤íŒ¨í•˜ë©´ ì—°ê²°ì„ ì¬ì‹œë„í•˜ë¼ëŠ” ì˜ë¯¸.

```python
# ê¸°ì¡´
redis_client_for_webhook = Redis(connection_pool=redis_pool_for_webhook)

# ê°œì„ 
redis_client_for_webhook = Redis(
    connection_pool=redis_pool_for_webhook,
    retry=Retry(ExponentialBackoff(base=0.1, cap=1), retries=3),
    retry_on_error=[RedisConnectionError, ConnectionResetError, TimeoutError],
)
```

ì´ëŸ¬ë©´ ì²« ì‹œë„ê°€ ì‹¤íŒ¨í•˜ë©´ 0.1ì´ˆ í›„, 0.2ì´ˆ í›„, 0.4ì´ˆ í›„, â€¦ ì´ëŸ°ì‹ìœ¼ë¡œ 3íšŒê¹Œì§€ë§Œ ì¬ì‹œë„í•œë‹¤(ìµœëŒ€ 1ì´ˆ)

## í…ŒìŠ¤íŠ¸

ì´ê²ƒì´ í•´ê²°ì±…ì´ ëœë‹¤ëŠ” ê²ƒì„ í™•ì¸í•˜ê¸° ìœ„í•´, ìƒí™©ì„ ì¬í˜„í•´ì•¼ í–ˆë‹¤.

1. Redis ìª½ì— ì§ì ‘ ëª…ë ¹ì„ ë³´ë‚´ ì—°ê²°ì„ ëŠì–´ë²„ë¦°ë‹¤(ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ëª¨ë¦„)
2. Retry ì˜µì…˜ì´ ì—†ëŠ” Redis í´ë¼ì´ì–¸íŠ¸ë¥¼ ì´ìš©í•´ ëŠì–´ì§„ ì—°ê²°ë¡œ ë°ì´í„° ì¶”ê°€ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
3. ë°ì´í„° ì¶”ê°€ê°€ ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
4. Retry ì˜µì…˜ì„ ì¶”ê°€í•œ ìƒíƒœë¡œ 3ì„ í™•ì¸í•œë‹¤.

ë©´ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

- ì½”ë“œ í™•ì¸
    
    ```python
    """
    Redis Connection Pool ì¢€ë¹„ ì»¤ë„¥ì…˜ ì˜¤ë¥˜ ì¬í˜„ ë° í•´ê²° ë°©ë²• ê²€ì¦
    
    ëª©ì :
    1. ê¸°ì¡´ ì„¤ì •ì—ì„œ "Connection closed by server" ì˜¤ë¥˜ ì¬í˜„
    2. ì‹ ê·œ ì„¤ì •(retry) ì ìš© í›„ ì˜¤ë¥˜ í•´ê²° í™•ì¸
    """
    
    import socket
    
    from django.core.management.base import BaseCommand
    from redis import Redis
    from redis.backoff import ExponentialBackoff
    from redis.exceptions import ConnectionError as RedisConnectionError
    from redis.retry import Retry
    
    from core.config.aws import (
        AWS_ELASTICACHE_WEBHOOK_REDIS_HOST,
        AWS_ELASTICACHE_WEBHOOK_REDIS_PORT,
    )
    from core.config.common import LOCAL
    
    class Command(BaseCommand):
        help = "Redis Connection Pool ì¢€ë¹„ ì»¤ë„¥ì…˜ ì˜¤ë¥˜ ì¬í˜„ ë° í•´ê²° ë°©ë²• ê²€ì¦"
    
        def handle(self, *args, **options):
            self.stdout.write(self.style.SUCCESS("\n" + "=" * 70))
            self.stdout.write(
                self.style.SUCCESS("Redis ì¢€ë¹„ ì»¤ë„¥ì…˜ ì˜¤ë¥˜ ì¬í˜„ ë° í•´ê²° ë°©ë²• ê²€ì¦")
            )
            self.stdout.write(self.style.SUCCESS("=" * 70))
    
            self.stdout.write("\n[í™˜ê²½ ì •ë³´]")
            self.stdout.write(f"  - LOCAL: {LOCAL}")
            self.stdout.write(f"  - REDIS_HOST: {AWS_ELASTICACHE_WEBHOOK_REDIS_HOST}")
            self.stdout.write(f"  - REDIS_PORT: {AWS_ELASTICACHE_WEBHOOK_REDIS_PORT}")
    
            # ========================================
            # í…ŒìŠ¤íŠ¸ 1: ê¸°ì¡´ ì„¤ì • (retry ì—†ìŒ)
            # ========================================
            self.stdout.write(self.style.WARNING("\n" + "=" * 70))
            self.stdout.write(self.style.WARNING("[í…ŒìŠ¤íŠ¸ 1] ê¸°ì¡´ ì„¤ì • (retry ì—†ìŒ)"))
            self.stdout.write(self.style.WARNING("=" * 70))
    
            old_errors = self._run_test(use_retry=False)
    
            # ========================================
            # í…ŒìŠ¤íŠ¸ 2: ì‹ ê·œ ì„¤ì • (retry ìˆìŒ)
            # ========================================
            self.stdout.write(self.style.WARNING("\n" + "=" * 70))
            self.stdout.write(self.style.WARNING("[í…ŒìŠ¤íŠ¸ 2] ì‹ ê·œ ì„¤ì • (retry ìˆìŒ)"))
            self.stdout.write(self.style.WARNING("=" * 70))
    
            new_errors = self._run_test(use_retry=True)
    
            # ========================================
            # ê²°ê³¼ ë¹„êµ
            # ========================================
            self._print_result(old_errors, new_errors)
    
        def _create_client(self, use_retry: bool) -> Redis:
            """Redis í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ë‹¨ì¼ ì»¤ë„¥ì…˜ ëª¨ë“œ)"""
            client_config = {
                "host": AWS_ELASTICACHE_WEBHOOK_REDIS_HOST,
                "port": int(AWS_ELASTICACHE_WEBHOOK_REDIS_PORT),
                "decode_responses": True,
                "single_connection_client": True,
            }
    
            if not LOCAL:
                client_config["ssl"] = True
                client_config["ssl_cert_reqs"] = None
    
            if use_retry:
                client_config["retry"] = Retry(
                    ExponentialBackoff(base=0.1, cap=1), retries=3
                )
                client_config["retry_on_error"] = [
                    RedisConnectionError,
                    ConnectionResetError,
                    TimeoutError,
                ]
    
            return Redis(**client_config)
    
        def _create_admin_client(self) -> Redis:
            """ê´€ë¦¬ìš© Redis í´ë¼ì´ì–¸íŠ¸ ìƒì„± (CLIENT KILLìš©)"""
            client_config = {
                "host": AWS_ELASTICACHE_WEBHOOK_REDIS_HOST,
                "port": int(AWS_ELASTICACHE_WEBHOOK_REDIS_PORT),
                "decode_responses": True,
            }
    
            if not LOCAL:
                client_config["ssl"] = True
                client_config["ssl_cert_reqs"] = None
    
            return Redis(**client_config)
    
        def _run_test(self, use_retry: bool) -> int:
            """ì¢€ë¹„ ì»¤ë„¥ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë§¤ ìš”ì²­ë§ˆë‹¤ ì¢€ë¹„í™”)"""
            errors = 0
            total_requests = 5
    
            if use_retry:
                self.stdout.write("  - retry: í™œì„±í™” (ìµœëŒ€ 3íšŒ, Exponential Backoff)")
            else:
                self.stdout.write("  - retry: ë¹„í™œì„±í™”")
    
            self.stdout.write(
                self.style.HTTP_INFO(
                    f"\n[í…ŒìŠ¤íŠ¸] ì¢€ë¹„ ìƒì„± â†’ ìš”ì²­ (x{total_requests}íšŒ ë°˜ë³µ)"
                )
            )
    
            for i in range(total_requests):
                try:
                    # ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                    client = self._create_client(use_retry)
    
                    # ì •ìƒ ì—°ê²° í™•ì¸ (ì»¤ë„¥ì…˜ ìƒì„±)
                    client.ping()
    
                    # ì»¤ë„¥ì…˜ ì¢€ë¹„í™”
                    zombie_created = self._create_zombie_connection(client, i)
                    if not zombie_created:
                        errors += 1
                        continue
    
                    # ì¢€ë¹„ ì»¤ë„¥ì…˜ìœ¼ë¡œ ìš”ì²­
                    client.set(f"zombie_test_{i}", f"value_{i}")
                    result = client.get(f"zombie_test_{i}")
                    client.delete(f"zombie_test_{i}")
    
                    self.stdout.write(
                        self.style.SUCCESS(f"    â†’ ìš”ì²­ {i}: âœ… SUCCESS (value={result})")
                    )
                    client.close()
    
                except Exception as e:
                    errors += 1
                    error_type = type(e).__name__
                    error_msg = str(e)[:50]
                    self.stdout.write(
                        self.style.ERROR(
                            f"    â†’ ìš”ì²­ {i}: âŒ FAILED [{error_type}] {error_msg}"
                        )
                    )
    
            return errors
    
        def _create_zombie_connection(self, client: Redis, request_num: int) -> bool:
            """ì»¤ë„¥ì…˜ì„ ì¢€ë¹„ ìƒíƒœë¡œ ë§Œë“¦"""
            conn = client.connection
    
            # ë°©ë²• 1: CLIENT KILL ì‚¬ìš© (ë¡œì»¬/ì¼ë°˜ Redis)
            try:
                client_id = client.client_id()
                admin_client = self._create_admin_client()
                admin_client.execute_command("CLIENT", "KILL", "ID", client_id)
                admin_client.close()
    
                self.stdout.write(
                    f"  [{request_num}] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID={client_id})"
                )
                return True
    
            except Exception:
                pass
    
            # ë°©ë²• 2: ì†Œì¼“ ê°•ì œ ì¢…ë£Œ (ElastiCache Serverless ë“±)
            if conn and hasattr(conn, "_sock") and conn._sock:
                try:
                    conn._sock.shutdown(socket.SHUT_RDWR)
                    self.stdout.write(f"  [{request_num}] ì¢€ë¹„ ìƒì„± (ì†Œì¼“ shutdown)")
                    return True
                except OSError:
                    conn._sock.close()
                    conn._sock = None
                    self.stdout.write(f"  [{request_num}] ì¢€ë¹„ ìƒì„± (ì†Œì¼“ close)")
                    return True
    
            self.stdout.write(self.style.ERROR(f"  [{request_num}] ì¢€ë¹„ ìƒì„± ì‹¤íŒ¨"))
            return False
    
        def _print_result(self, old_errors: int, new_errors: int):
            """ê²°ê³¼ ì¶œë ¥"""
            self.stdout.write(self.style.WARNING("\n" + "=" * 70))
            self.stdout.write(self.style.WARNING("[í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¹„êµ]"))
            self.stdout.write(self.style.WARNING("=" * 70))
    
            self.stdout.write(f"\n{'ì„¤ì •':<30} {'ì—ëŸ¬ ìˆ˜':<10} {'ê²°ê³¼':<6}")
            self.stdout.write("-" * 50)
    
            old_status = "âŒ FAIL" if old_errors > 0 else "âœ… PASS"
            new_status = "âŒ FAIL" if new_errors > 0 else "âœ… PASS"
    
            self.stdout.write(
                f"{'ê¸°ì¡´ ì„¤ì • (retry ì—†ìŒ)':<30} {old_errors:<10} {old_status}"
            )
            self.stdout.write(
                f"{'ì‹ ê·œ ì„¤ì • (retry ìˆìŒ)':<30} {new_errors:<10} {new_status}"
            )
    
            # ê²°ë¡ 
            self.stdout.write("\n" + "=" * 70)
            self.stdout.write("[ê²°ë¡ ]")
            self.stdout.write("=" * 70)
    
            if old_errors > 0 and new_errors == 0:
                self.stdout.write(
                    self.style.SUCCESS(
                        "\nâœ… ê¸°ì¡´ ì„¤ì •ì—ì„œ ì—ëŸ¬ ë°œìƒ, ì‹ ê·œ ì„¤ì •ì—ì„œ í•´ê²°ë¨!"
                    )
                )
                self.stdout.write(f"   - ê¸°ì¡´ ì„¤ì •: {old_errors}ê±´ ì—ëŸ¬")
                self.stdout.write(f"   - ì‹ ê·œ ì„¤ì •: 0ê±´ ì—ëŸ¬ (ëª¨ë‘ ì„±ê³µ)")
                self.stdout.write("\nâ†’ retry ì„¤ì •ì´ ì¢€ë¹„ ì»¤ë„¥ì…˜ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.")
                self.stdout.write("\n[ê¶Œì¥ ì„¤ì •]")
                self.stdout.write("-" * 50)
                self.stdout.write(
                    """
       client = Redis(
           connection_pool=redis_pool_for_webhook,
           retry=Retry(ExponentialBackoff(base=0.1, cap=1), retries=3),
           retry_on_error=[ConnectionError, ConnectionResetError, TimeoutError],
       )
    """
                )
            elif old_errors > 0 and new_errors > 0:
                self.stdout.write(self.style.WARNING("\nâš ï¸ ì–‘ìª½ ëª¨ë‘ ì—ëŸ¬ ë°œìƒ"))
                self.stdout.write(f"   - ê¸°ì¡´ ì„¤ì •: {old_errors}ê±´ ì—ëŸ¬")
                self.stdout.write(f"   - ì‹ ê·œ ì„¤ì •: {new_errors}ê±´ ì—ëŸ¬")
            elif old_errors == 0 and new_errors == 0:
                self.stdout.write(self.style.SUCCESS("\nâœ… ì–‘ìª½ ëª¨ë‘ ì„±ê³µ"))
                self.stdout.write("   - redis-pyê°€ ë‚´ë¶€ì ìœ¼ë¡œ ìë™ ë³µêµ¬ë¥¼ ìˆ˜í–‰")
            else:
                self.stdout.write(self.style.ERROR("\nâŒ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼"))
    
            self.stdout.write("")
    
    ```
    

ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•´ë³´ë‹ˆ ë‹¤ìŒê³¼ê°™ì´ ì¶œë ¥ë˜ì—ˆë‹¤.

```
======================================================================
Redis ì¢€ë¹„ ì»¤ë„¥ì…˜ ì˜¤ë¥˜ ì¬í˜„ ë° í•´ê²° ë°©ë²• ê²€ì¦
======================================================================

[í™˜ê²½ ì •ë³´]
  - LOCAL: True
  - REDIS_HOST: core-redis
  - REDIS_PORT: 6379

======================================================================
[í…ŒìŠ¤íŠ¸ 1] ê¸°ì¡´ ì„¤ì • (retry ì—†ìŒ)
======================================================================
  - retry: ë¹„í™œì„±í™”

[í…ŒìŠ¤íŠ¸] ì¢€ë¹„ ìƒì„± â†’ ìš”ì²­ (x5íšŒ ë°˜ë³µ)
  [0] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=3)
    â†’ ìš”ì²­ 0: âŒ FAILED [ConnectionError] Connection closed by server.
  [1] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=5)
    â†’ ìš”ì²­ 1: âŒ FAILED [ConnectionError] Connection closed by server.
  [2] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=7)
    â†’ ìš”ì²­ 2: âŒ FAILED [ConnectionError] Connection closed by server.
  [3] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=9)
    â†’ ìš”ì²­ 3: âŒ FAILED [ConnectionError] Connection closed by server.
  [4] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=11)
    â†’ ìš”ì²­ 4: âŒ FAILED [ConnectionError] Connection closed by server.

======================================================================
[í…ŒìŠ¤íŠ¸ 2] ì‹ ê·œ ì„¤ì • (retry ìˆìŒ)
======================================================================
  - retry: í™œì„±í™” (ìµœëŒ€ 3íšŒ, Exponential Backoff)

[í…ŒìŠ¤íŠ¸] ì¢€ë¹„ ìƒì„± â†’ ìš”ì²­ (x5íšŒ ë°˜ë³µ)
  [0] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=13)
    â†’ ìš”ì²­ 0: âœ… SUCCESS (value=value_0)
  [1] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=16)
    â†’ ìš”ì²­ 1: âœ… SUCCESS (value=value_1)
  [2] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=19)
    â†’ ìš”ì²­ 2: âœ… SUCCESS (value=value_2)
  [3] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=22)
    â†’ ìš”ì²­ 3: âœ… SUCCESS (value=value_3)
  [4] ì¢€ë¹„ ìƒì„± (CLIENT KILL, ID=25)
    â†’ ìš”ì²­ 4: âœ… SUCCESS (value=value_4)

======================================================================
[í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¹„êµ]
======================================================================

ì„¤ì •                             ì—ëŸ¬ ìˆ˜       ê²°ê³¼    
--------------------------------------------------
ê¸°ì¡´ ì„¤ì • (retry ì—†ìŒ)               5          âŒ FAIL
ì‹ ê·œ ì„¤ì • (retry ìˆìŒ)               0          âœ… PASS

======================================================================
[ê²°ë¡ ]
======================================================================

âœ… ê¸°ì¡´ ì„¤ì •ì—ì„œ ì—ëŸ¬ ë°œìƒ, ì‹ ê·œ ì„¤ì •ì—ì„œ í•´ê²°ë¨!
   - ê¸°ì¡´ ì„¤ì •: 5ê±´ ì—ëŸ¬
   - ì‹ ê·œ ì„¤ì •: 0ê±´ ì—ëŸ¬ (ëª¨ë‘ ì„±ê³µ)

â†’ retry ì„¤ì •ì´ ì¢€ë¹„ ì»¤ë„¥ì…˜ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.

[ê¶Œì¥ ì„¤ì •]
--------------------------------------------------

   client = Redis(
       connection_pool=redis_pool_for_webhook,
       retry=Retry(ExponentialBackoff(base=0.1, cap=1), retries=3),
       retry_on_error=[ConnectionError, ConnectionResetError, TimeoutError],
   )
```

## ê²°ë¡ 

1. Redisìª½ì—ì„œ ì—°ê²°ì´ ëŠê¸°ë©´ `[ConnectionError] Connection closed by server.` ê°€ ë°œìƒí•œë‹¤.
2. retry ì˜µì…˜ìœ¼ë¡œ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
3. ì™œ ì—°ê²°ì´ ëŠê²¼ëŠ”ì§€ëŠ” ëª¨ë¥¸ë‹¤.

ì•ìœ¼ë¡œ ì§€ì¼œë³¼ ì˜ˆì •.