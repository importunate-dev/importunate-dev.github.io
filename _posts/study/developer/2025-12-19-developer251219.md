---
layout: post
title: "LocalStackì„ ì´ìš©í•´ ë¡œì»¬ì—ì„œ AWS êµ¬ë™ì‹œí‚¤ê¸°"
subtitle: ""
catalog: true
category: study
subcategory: developer
tags:
  - developer
  - study
  - redis
  - connection

---

# ë¡œì»¬ ì›¹í›… í…ŒìŠ¤íŠ¸ í™˜ê²½

ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ AWSë¥¼ ì´ìš©í•˜ëŠ” ì „ì²´ ì›¹í›… í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ êµ¬ì¶•í•¨

---

## ê°œìš”

### ë°°ê²½

ìš´ì˜ í™˜ê²½ì˜ ì›¹í›… ì²˜ë¦¬ í”Œë¡œìš°:

```
Cafe24 â†’ Django â†’ SQS â†’ EventBridge Pipes â†’ Step Functions â†’ Lambda â†’ ElastiCache

```

ì´ í”Œë¡œìš°ë¥¼ ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë ¤ì› ë˜ ì´ìœ :

- Lambda í•¨ìˆ˜ê°€ ElastiCache(AWS)ì—ë§Œ ì ‘ê·¼ ê°€ëŠ¥
- LocalStack Freeì—ì„œ EventBridge Pipes ë¯¸ì§€ì›

### í•´ê²° ë°©ë²•

**LocalStackì„ í™œìš©í•œ í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜:**

- ì›¹í›… ì²˜ë¦¬ â†’ LocalStack (Step Functions + Lambda)
- ê¸°íƒ€ AWS ì„œë¹„ìŠ¤ (SQS, S3) â†’ ì‹¤ì œ AWS ìœ ì§€

---

## ğŸ’¡ í•µì‹¬ ê°œë…: LocalStackê³¼ Endpoint URL

ì´ í”„ë¡œì íŠ¸ëŠ” **í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ í™˜ê²½**ì„ êµ¬ì„±í•˜ê¸° ìœ„í•´ LocalStackê³¼ `endpoint_url` ê°œë…ì„ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 1. LocalStackì´ë€?

**LocalStack**ì€ ë‚´ ì»´í“¨í„°(ë¡œì»¬ í™˜ê²½)ì—ì„œ ì‹¤í–‰ë˜ëŠ” **AWS í´ë¼ìš°ë“œ ì—ë®¬ë ˆì´í„°**ì…ë‹ˆë‹¤. ì‹¤ì œ AWSì— ë¹„ìš©ì„ ì§€ë¶ˆí•˜ê±°ë‚˜ ì¸í„°ë„·ì„ ì—°ê²°í•˜ì§€ ì•Šê³ ë„, ë‚´ ì»´í“¨í„° ì•ˆì—ì„œ S3, Lambda, DynamoDB ë“±ì˜ AWS ì„œë¹„ìŠ¤ë¥¼ ê°€ì§œë¡œ ë„ì›Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

- **ì´ í”„ë¡œì íŠ¸ì—ì„œì˜ ì—­í• :** ë¹„ìš©ì´ ë“¤ê³  êµ¬ì„±ì´ ë³µì¡í•œ ì›¹í›… ì²˜ë¦¬ ë¡œì§(Step Functions, Lambda)ì„ ì‹¤ì œ AWS ëŒ€ì‹  LocalStack ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.

### 2. Endpoint URLì´ë€?

AWS SDK(Boto3 ë“±)ê°€ ëª…ë ¹ì„ ë³´ë‚¼ **ëª©ì ì§€ ì£¼ì†Œ**ì…ë‹ˆë‹¤.

- **ê¸°ë³¸ê°’ (Real AWS):** ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ `https://sqs.ap-northeast-2.amazonaws.com` ê°™ì€ ì‹¤ì œ AWS ê³µìš© ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
- **LocalStack ì„¤ì •:** `endpoint_url`ì„ LocalStack ì£¼ì†Œë¡œ ê°•ì œ ì§€ì •í•˜ë©´, ìš”ì²­ì´ ì‹¤ì œ AWSê°€ ì•„ë‹Œ ë‚´ ë¡œì»¬ ì»¨í…Œì´ë„ˆë¡œ í–¥í•˜ê²Œ ë©ë‹ˆë‹¤.

### 3. ì´ í”„ë¡œì íŠ¸ì˜ í•˜ì´ë¸Œë¦¬ë“œ êµ¬ì„± (Docker Network)

ì´ í™˜ê²½ì—ì„œëŠ” **ì–´ë–¤ ì„œë¹„ìŠ¤ëƒì— ë”°ë¼** ìš”ì²­ì„ ë³´ë‚´ëŠ” ê³³(Endpoint)ì„ ë‹¤ë¥´ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.

| êµ¬ë¶„ | ëŒ€ìƒ ì„œë¹„ìŠ¤ | Endpoint URL ì„¤ì • ê°’ | ì„¤ëª… |
| --- | --- | --- | --- |
| **ì‹¤ì œ AWS** | SQS, S3 | `None` (ê¸°ë³¸ê°’) | ì‹¤ì œ AWS ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. |
| **LocalStack** | Step Functions, Lambda | `http://core-localstack:4566` | ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ì˜ LocalStack ì»¨í…Œì´ë„ˆë¡œ ìš”ì²­ì„ ê°€ë¡œì±•ë‹ˆë‹¤. |

> âš ï¸ ì£¼ì˜: ë¡œì»¬ PC(Host)ì—ì„œ ì ‘ì†í•  ë•ŒëŠ” localhost:4566ì„ ì“°ì§€ë§Œ, ë„ì»¤ ì»¨í…Œì´ë„ˆ(core-backend) ë‚´ë¶€ë¼ë¦¬ í†µì‹ í•  ë•ŒëŠ” ì„œë¹„ìŠ¤ëª…ì¸ core-localstack:4566ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
> 

---

## ì•„í‚¤í…ì²˜

### ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           core-backend                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   [ì¼ë°˜ AWS ì‘ì—…]                    [ì›¹í›… í…ŒìŠ¤íŠ¸]                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ SQS_CLIENT          â”‚           â”‚ LOCALSTACK_         â”‚             â”‚
â”‚   â”‚ S3_CLIENT           â”‚           â”‚ STEPFUNCTIONS_      â”‚             â”‚
â”‚   â”‚ (Endpoint: Default) â”‚           â”‚ CLIENT              â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ (Endpoint: Local)   â”‚             â”‚
â”‚              â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚              â”‚                                 â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                 â”‚
               â–¼                                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ì‹¤ì œ AWS  â”‚                  â”‚   LocalStack   â”‚
        â”‚ (SQS, S3)  â”‚                  â”‚ (ì›¹í›… ì „ìš©)    â”‚
        â”‚ ê³„ì •: 341..â”‚                  â”‚ ê³„ì •: 000000.. â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚  core-redis    â”‚
                                       â”‚ (í† í° + ê²°ê³¼)  â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

### ì›¹í›… ì²˜ë¦¬ í”Œë¡œìš° (ë¡œì»¬)

```
1. ì›¹í›… ìˆ˜ì‹ 
              â”‚
              â–¼
2. Django ë·° (views.py)
   - LOCAL=True í™•ì¸
   - SQS ëŒ€ì‹  Step Functions ì§ì ‘ í˜¸ì¶œ (endpoint_url: core-localstack)
              â”‚
              â–¼
3. LocalStack Step Functions
   - Core-System-Local-Webhook ìƒíƒœ ë¨¸ì‹  ì‹¤í–‰
              â”‚
              â–¼
4. Token Lambda (LocalStack)
   - core-redisì—ì„œ OAuth í† í° ì¡°íšŒ
   - access_tokenì„ payloadì— ì¶”ê°€
              â”‚
              â–¼
5. ì›¹í›… ì¢…ë¥˜ë³„ Lambda (LocalStack)
   - Cafe24 API í˜¸ì¶œ (ì‹¤ì œ ì™¸ë¶€ í†µì‹ )
   - ê²°ê³¼ë¥¼ core-redisì— ì €ì¥
              â”‚
              â–¼
6. ê²°ê³¼ í™•ì¸
   docker exec core-redis redis-cli KEYS "webhook:*"

```

### ì»¨í…Œì´ë„ˆ êµ¬ì„±

| ì»¨í…Œì´ë„ˆ | í¬íŠ¸ | ìš©ë„ | ë¹„ê³  |
| --- | --- | --- | --- |
| `core-backend` | 8000 | Django ì„œë²„ | ì›¹í›… ìˆ˜ì‹  |
| `core-localstack` | 4566 | AWS ì—ë®¬ë ˆì´ì…˜ | Step Functions, Lambda |
| `core-redis` | 6379 | OAuth í† í° + ì›¹í›… ê²°ê³¼ ì €ì¥ | í†µí•© Redis |
| `core-db` | 5432 | PostgreSQL | ê¸°ì¡´ DB |

---

### í•µì‹¬ ì½”ë“œ ë³€ê²½

**1. AWS í´ë¼ì´ì–¸íŠ¸ ë¶„ë¦¬ (`core/config/aws.py`)**

```python
# ê¸°ë³¸ í´ë¼ì´ì–¸íŠ¸ëŠ” í•­ìƒ ì‹¤ì œ AWS ì‚¬ìš© (endpoint_url ë¯¸ì§€ì • = ì‹¤ì œ AWS)
_AWS_DEFAULT_ENDPOINT = "https://sqs.ap-northeast-2.amazonaws.com"
SQS_CLIENT = boto3.resource(
    "sqs",
    region_name=REGION,
    endpoint_url=_AWS_DEFAULT_ENDPOINT if AWS_ENDPOINT_URL else None,
)

# LocalStack ì „ìš© í´ë¼ì´ì–¸íŠ¸ (ì›¹í›… í…ŒìŠ¤íŠ¸ìš©)
# AWS_ENDPOINT_URL í™˜ê²½ë³€ìˆ˜ê°€ 'http://core-localstack:4566'ìœ¼ë¡œ ì„¤ì •ë¨
LOCALSTACK_STEPFUNCTIONS_CLIENT = None
if LOCAL and AWS_ENDPOINT_URL:
    LOCALSTACK_STEPFUNCTIONS_CLIENT = boto3.client(
        "stepfunctions",
        region_name=REGION,
        endpoint_url=AWS_ENDPOINT_URL, # ì—¬ê¸°ì„œ LocalStackì„ ë°”ë¼ë³´ê²Œ ë¨
        ...
    )
```

**3. Lambda SQS/Step Functions í˜¸í™˜ì„± (`webhook-*/lambda_function.py`)**

```python
def lambda_handler(event: dict, context: Any) -> None:
    # SQS í˜•íƒœ(Records)ì™€ Step Functions ì§ì ‘ í˜¸ì¶œ(Flat JSON) ëª¨ë‘ ì²˜ë¦¬
    if "Records" in event:
        # SQSë¥¼ í†µí•´ íŠ¸ë¦¬ê±°ëœ ê²½ìš°
        body = event["Records"][0]["body"]
        if isinstance(body, str):
            body = json.loads(body)
    else:
        # Step Functionsì—ì„œ ì§ì ‘ í˜¸ì¶œëœ ê²½ìš° (Local í…ŒìŠ¤íŠ¸ í™˜ê²½ í¬í•¨)
        body = event

    # platform_idì™€ platform_ids ëª¨ë‘ ì§€ì› (í˜¸í™˜ì„±)
    platform_id = body.get("platform_id") or body.get("platform_ids")
    ...
```

**4. Lambda Redis SSL ë¶„ê¸°**

```python
REDIS_SSL = os.getenv("REDIS_SSL", "true").lower() == "true"

r = Redis(
    host=CORE_REDIS_HOST,
    port=CORE_REDIS_PORT,
    ssl=REDIS_SSL,  # ë¡œì»¬ì—ì„œëŠ” false
    decode_responses=True,
)
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Lambda í•¨ìˆ˜ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ

```bash
# LocalStack ë¡œê·¸ í™•ì¸
docker logs core-localstack | tail -50

# ìˆ˜ë™ìœ¼ë¡œ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
docker exec core-localstack bash /etc/localstack/init/ready.d/init.sh

# Lambda í•¨ìˆ˜ í™•ì¸ (AWS CLI ì‚¬ìš© ì‹œ endpoint í•„ìˆ˜)
aws --endpoint-url=http://localhost:4566 lambda list-functions
```

### SQS íë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ ì˜¤ë¥˜

**ì¦ìƒ:** `The specified queue does not exist`

**ì›ì¸:** `AWS_ENDPOINT_URL` í™˜ê²½ë³€ìˆ˜ê°€ ì „ì—­ìœ¼ë¡œ ì„¤ì •ë˜ì–´ boto3ê°€ SQS ìš”ì²­ë§ˆì € LocalStackìœ¼ë¡œ ë³´ë‚´ë²„ë¦¼

**í•´ê²°:** `core/config/aws.py`ì—ì„œ SQS_CLIENT ìƒì„± ì‹œ `endpoint_url`ì„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•˜ì—¬ ì‹¤ì œ AWSë¥¼ ë°”ë¼ë³´ë„ë¡ ìˆ˜ì •

```python
SQS_CLIENT = boto3.resource(
    "sqs",
    region_name=REGION,
    # AWS_ENDPOINT_URLì´ ìˆì–´ë„ ê°•ì œë¡œ ì‹¤ì œ AWS ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ Noneìœ¼ë¡œ ì„¤ì •
    endpoint_url="https://sqs.ap-northeast-2.amazonaws.com" if AWS_ENDPOINT_URL else None,
)
```

### Redis ì—°ê²° ì˜¤ë¥˜ (Lambda)

**ì¦ìƒ:** Lambdaì—ì„œ Redis ì—°ê²° ì‹¤íŒ¨

**ì›ì¸:** ë¡œì»¬ RedisëŠ” SSLì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

**í•´ê²°:** Lambda í™˜ê²½ë³€ìˆ˜ì— `REDIS_SSL=false` ì„¤ì • (init.shì—ì„œ ìë™ ì„¤ì •ë¨)

### Step Functions ì‹¤í–‰ ì‹¤íŒ¨

```bash
# ì‹¤í–‰ ì´ë ¥ í™•ì¸
aws --endpoint-url=http://localhost:4566 stepfunctions list-executions \
  --state-machine-arn arn:aws:states:us-east-1:000000000000:stateMachine:Core-System-Local-Webhook

# íŠ¹ì • ì‹¤í–‰ ìƒì„¸ ì •ë³´
aws --endpoint-url=http://localhost:4566 stepfunctions describe-execution \
  --execution-arn <EXECUTION_ARN>
```

### core-backend ì‹œì‘ ì‹¤íŒ¨ (Secrets Manager ì˜¤ë¥˜)

**ì¦ìƒ:** `Service 'secretsmanager' is not enabled`

**ì›ì¸:** LOCAL í™˜ê²½ì—ì„œ Secrets Manager í˜¸ì¶œ ì‹œë„ (Endpointê°€ LocalStackìœ¼ë¡œ ì¡í˜€ìˆìœ¼ë‚˜ LocalStack Freeë²„ì „ì´ê±°ë‚˜ ì´ˆê¸°í™” ì•ˆë¨)

**í•´ê²°:** `core/config/database.py`ì—ì„œ LOCAL í™˜ê²½ì¼ ë•Œ í™˜ê²½ë³€ìˆ˜ì—ì„œ ì§ì ‘ DB ì •ë³´ ë¡œë“œ

---

## ê´€ë ¨ ë¬¸ì„œ

- [LocalStack ê³µì‹ ë¬¸ì„œ](https://docs.localstack.cloud/)
